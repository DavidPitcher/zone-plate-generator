%!PS
%%Title: Zoneplate Generator
%%Creator: David Pitcher
%%CreationDate: July 6, 2025
%%DocumentPaperSizes: Letter

%***********************************************************************
% Change the following numbers to suit your Zoneplate
%***********************************************************************

/FOCAL 210 def              % change number to whatever focal length in mm you want

/RINGS 6 def                % number of zones

/PUNCH_DIAMETER 10 def      % diamter of the punch outline to the out the zone plate

/MAG 1 def                  % change number to whatever magnification you want the
                            % printed zone plate to be

/WAVE_LENGTH 0.00056 def    % change number to whatever wavelength in mm you want
                            % 0.00022 is the wavelength of green light
                            % 0.00056 is the wavelength of daylight

/SIEVE_SCALE 1.5 def        % Scale factor for sieve holes on a ring

/SIEVE_SPACE 0.03  def        % Space between sieve holes in mm

/ROWS 1 def     % 3 number of rows of zone plates
/COLS 1 def     % 9 number of columns of zone plates per row

/DEBUG false def

%************************************************************************
% Zone Plate can be magnified to allow for printing larger and 
% photograping onto film
%************************************************************************
/mmToPoints {2.83 mul} def                    % converts mm to points
/pointsToMm {2.83 div} def                    % converts points to mm
/pointsToMicrons {352.778 mul} def            % converts points to microns (µm)
/pi 3.1415926536 def                          % define pi
/area 0 def                                   % initialize variable "area" to store
                                              % the sum of areas of all zones
/counter 0 def                                % initialize counter of clear zones
/logsqrt2 2 sqrt log def                      % log(sqrt(2))

%/center WAVE_LENGTH FOCAL mul sqrt ZP_CONST mul MAG mul mmToPoints def  % size of central pinhole in points  
/pagewidth 215 def  % width of the page in mm
/pageheight 279 def % height of the page in mm
/totalZonePlateSize 21.5 def
/currentRowIndex 1 def
/offsetx {totalZonePlateSize mul mmToPoints} def % offset for x-axis
/offsety {pageheight exch totalZonePlateSize mul sub mmToPoints} def % offset for y-axis

gsave 
%******************************************************************

%*****************************************************************
% Calculate the Current Ring Radius
%*****************************************************************
/calc_radius_mm {
    % ring radius = sqrt(n * λ * f + (n^2 * λ^2) / 4)
    % n is on stack and represents the ring number
    dup dup mul WAVE_LENGTH dup mul mul 4 div   % (n^2*λ^2)/4
    exch WAVE_LENGTH mul FOCAL mul add          % n * λ * f + (n^2*λ^2)/4
    sqrt MAG mul                                % sqrt(n * λ * f + (n^2 * λ^2) / 4) * M
} def
%*****************************************************************

%*****************************************************************
% Calculate Number of Sieve Circles in a Ring
% Usage: annulus_radius_mm ring_center_radius_mm calc_num_circles → num_circles
%*****************************************************************
/calc_num_circles {
    % Annulus Width on stack
    % Annulus Center Radius on stack
    /c_r exch def
    /a_w exch def
    /circumference_mm c_r 2 mul pi mul def % circumference = 2 * π * r
    circumference_mm a_w SIEVE_SPACE add div floor cvi
} def
%*****************************************************************

%*****************************************************************
% Calculate effective f-stop
% Usage: num_rings focal_length calc_effective_fstop → fstop
%******************************************************************
/calc_effective_fstop {
    % num_rings focal_length on stack
    % Calculate radius of innermost ring (n=1) in mm
    /fstop_fl exch def
    /fstop_r exch def

    /center_ring_area 1 calc_radius_mm MAG div dup mul pi mul def

    % Total effective area = area of center ring * number of rings
    % Calculate effective diameter from total area
    % Calculate f-stop: f/D
    /fstop_effective_area center_ring_area fstop_r mul def
    /fstop_effective_diameter fstop_effective_area 4 mul pi div sqrt def % D = 2 * sqrt(A/π) = sqrt(4A/π) def
    fstop_fl fstop_effective_diameter div 0.5 add cvi
} def
%*****************************************************************

%*****************************************************************
% Draw 8" x 10" frame around page
%*****************************************************************
/drawBorder {
    gsave   
    1 mmToPoints setlinewidth                % Set line width
    newpath
    10 mmToPoints 269 mmToPoints moveto      % Start at (10mm, 269mm)
    pagewidth 20 sub mmToPoints 0 rlineto    % Draw to the right
    0 20 pageheight sub mmToPoints rlineto   % Draw down
    20 pagewidth sub mmToPoints 0 rlineto    % Draw left
    closepath
    stroke
    grestore
} def
%*****************************************************************  

%*****************************************************************
% Draw Zone Plates in Grid Pattern
%*****************************************************************
/drawZonePlate {
    /colIndex exch def
    /rowIndex exch def

    gsave

    % Translate current position to correct grid position
    colIndex offsetx rowIndex offsety translate
    
    % Draw Punch Outline to cut zone plate from film
    0 setgray                                  
    .5 mmToPoints setlinewidth                                                  
    0 0 PUNCH_DIAMETER MAG mul 2 div mmToPoints 0 360 arc 
    stroke
    
    1 2 RINGS 2 mul {
        /n exch def
        
        /outer_radius_mm n calc_radius_mm def
        /inner_radius_mm n 1 sub calc_radius_mm def
        /annulus_width_mm outer_radius_mm inner_radius_mm sub def

        % Calculate the center of the ring (midpoint between inner and outer radii)
        /ring_center_radius_mm inner_radius_mm annulus_width_mm 2 div add def

        0 setgray
        annulus_width_mm mmToPoints setlinewidth
        0 0 ring_center_radius_mm mmToPoints 0 360 arc
        stroke
        
    } for 

    grestore
} def
%*****************************************************************  

%*****************************************************************
% Draw Zone Sieve in Grid Pattern
%*****************************************************************
/drawZoneSieve {
    /colIndex exch def
    /rowIndex exch def

    gsave

    % Translate current position to correct grid position
    colIndex offsetx rowIndex offsety translate
    
    % Draw Punch Outline to cut zone plate from film
    0 setgray                                  
    .5 mmToPoints setlinewidth                                                   
    0 0 PUNCH_DIAMETER MAG mul 2 div mmToPoints 0 360 arc 
    stroke
    
    1 2 RINGS 2 mul {
        /n exch def
        
        /outer_radius_mm n calc_radius_mm def
        /inner_radius_mm n 1 sub calc_radius_mm def
        /annulus_width_mm outer_radius_mm inner_radius_mm sub def

        % Calculate the center of the ring (midpoint between inner and outer radii)
        /ring_center_radius_mm inner_radius_mm annulus_width_mm 2 div add def
        n 1 eq {
            0 setgray
            annulus_width_mm mmToPoints setlinewidth
            0 0 ring_center_radius_mm mmToPoints 0 360 arc
            stroke 
        } {
            /num_circles annulus_width_mm SIEVE_SCALE mul ring_center_radius_mm calc_num_circles def
            /rotation 360 num_circles div def
            % Draw circles along the annulus (optional)
            1 1 num_circles {               
               0 setgray 
               rotation rotate
               ring_center_radius_mm mmToPoints 0 annulus_width_mm SIEVE_SCALE mul 2 div mmToPoints 0 360 arc fill
            } for
        } ifelse
    } for

    grestore
} def
%***************************************************************** 

%*****************************************************************
% Draw Photon Sieve in Grid Pattern
%*****************************************************************
/drawPhotonSieve {
    /colIndex exch def
    /rowIndex exch def

    gsave

    % Translate current position to correct grid position
    colIndex offsetx rowIndex offsety translate
    
    % Draw Punch Outline to cut zone plate from film
    0 setgray                                  
    .5 mmToPoints setlinewidth                                                   
    0 0 PUNCH_DIAMETER MAG mul 2 div mmToPoints 0 360 arc 
    stroke
    
    1 2 RINGS 2 mul {
        /n exch def
        
        /outer_radius_mm n 1 add calc_radius_mm def
        /inner_radius_mm n calc_radius_mm def
        /annulus_width_mm outer_radius_mm inner_radius_mm sub def

        % Calculate the center of the ring (midpoint between inner and outer radii)
        /ring_center_radius_mm inner_radius_mm annulus_width_mm 2 div add def
        /num_circles annulus_width_mm SIEVE_SCALE mul ring_center_radius_mm calc_num_circles def
        /rotation 360 num_circles div def
        % Draw circles along the annulus (optional)
        1 1 num_circles {               
            0 setgray 
            rotation rotate
            ring_center_radius_mm mmToPoints 0 annulus_width_mm SIEVE_SCALE mul 2 div mmToPoints 0 360 arc fill
        } for
    } for

    grestore
} def
%*****************************************************************  

/drawZonePlateDescription {
    /colIndex exch def
    /rowIndex exch def
    gsave
    
    colIndex offsetx rowIndex offsety moveto
    
    /Times-Roman findfont
    10 scalefont
    setfont
    0 setgray
    /str 150 string def
    (Focal Length: ) show
    FOCAL str cvs show
    (mm) show
    ( | Zones: ) show
    RINGS str cvs show
    ( | Zone Plate Diameter: ) show
    RINGS 2 mul 1 sub calc_radius_mm 2 mul str cvs show
    (mm) show
    ( | F/Stop: ) show
    RINGS FOCAL calc_effective_fstop str cvs show
    
    grestore
} def

/drawZoneSieveDescription {
    /colIndex exch def
    /rowIndex exch def
    gsave
    
    colIndex offsetx rowIndex offsety moveto
    
    /Times-Roman findfont
    10 scalefont
    setfont
    0 setgray
    /str 150 string def
    (Focal Length: ) show
    FOCAL str cvs show
    (mm) show
    ( | Zones: ) show
    RINGS str cvs show
    ( | Zone Plate Diameter: ) show
    RINGS 2 mul 1 sub calc_radius_mm 2 mul str cvs show
    (mm) show
    ( | F/Stop: ) show
    RINGS FOCAL calc_effective_fstop str cvs show
    
    grestore
} def


% Draw border around the page
drawBorder

% %Draw grid of Zone Plated
% 0 1 ROWS 1 sub {                                    
%      /row exch def
%     1 1 COLS {                                
%         /col exch def
%         row currentRowIndex add col drawZonePlate                 
%     } for
% } for
% /currentRowIndex ROWS currentRowIndex add def

% %Print zone plate description
% currentRowIndex 1 drawZonePlateDescription
% /currentRowIndex 1 currentRowIndex add def

% % Draw grid of Zone Sieves
% 0 1 ROWS 1 sub {                                    
%     /row exch def
%     1 1 COLS {                                
%         /col exch def
%         row currentRowIndex add col drawZoneSieve                 
%     } for
% } for
% /currentRowIndex ROWS currentRowIndex add def

% % Print zone plate description
% currentRowIndex 1 drawZoneSieveDescription
% /currentRowIndex 1 currentRowIndex add def

% Draw grid of Zone Sieves
0 1 ROWS 1 sub {                                    
    /row exch def
    1 1 COLS {                                
        /col exch def
        row currentRowIndex add col drawPhotonSieve                 
    } for
} for
/currentRowIndex ROWS currentRowIndex add def

% % Print zone plate description
% currentRowIndex 1 drawZoneSieveDescription
% /currentRowIndex 1 currentRowIndex add def


showpage

