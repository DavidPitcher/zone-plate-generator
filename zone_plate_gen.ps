%!PS
%%Title: Zoneplate Generator
%%Creator: David Pitcher
%%CreationDate: July 6, 2025
%%DocumentPaperSizes: Letter

%***********************************************************************
% Change the following numbers to suit your Zoneplate
%***********************************************************************

/FOCAL 210 def              % change number to whatever focal length in mm you want

/RINGS 6 def                % number of zones

/PUNCH_DIAMETER 10 def      % diamter of the punch outline to the out the zone plate

/MAG 1 def                  % change number to whatever magnification you want the
                            % printed zone plate to be

/WAVE_LENGTH 0.00056 def    % change number to whatever wavelength in mm you want
                            % 0.00022 is the wavelength of green light
                            % 0.00056 is the wavelength of daylight

/ZP_CONST 1.86 def          % Zone plate constant 

/S 0.1 def                  % extra width to add to pinhole diameter with the purpose of 
                            % deciding the number of pinholes in each zone.  Use 2 or more,
                            % decimals are ok (i.e.: 2.3). The larger the number the 
                            % less pinholes in each ring.

/ROWS 1 def     % 3 number of rows of zone plates
/COLS 1 def     % 9 number of columns of zone plates per row

/DEBUG false def

%************************************************************************
% Zone Plate can be magnified to allow for printing larger and 
% photograping onto film
%************************************************************************
/mmToPoints {2.83 mul} def                    % converts mm to points
/pointsToMm {2.83 div} def                    % converts points to mm
/pointsToMicrons {352.778 mul} def            % converts points to microns (µm)
/pi 3.1415926536 def                          % define pi
/area 0 def                                   % initialize variable "area" to store
                                              % the sum of areas of all zones
/counter 0 def                                % initialize counter of clear zones
/logsqrt2 2 sqrt log def                      % log(sqrt(2))

/center WAVE_LENGTH FOCAL mul sqrt ZP_CONST mul MAG mul mmToPoints def  % size of central pinhole in points  
/pagewidth 215 def  % width of the page in mm
/pageheight 279 def % height of the page in mm
/totalZonePlateSize 21.5 def
/currentRowIndex 1 def
/offsetx {totalZonePlateSize mul mmToPoints} def % offset for x-axis
/offsety {pageheight exch totalZonePlateSize mul sub mmToPoints} def % offset for y-axis

gsave 
%******************************************************************

%*****************************************************************
% Calculate the Current Ring Radius
%*****************************************************************
/calc_radius_mm {
    % ring radius = sqrt(n * λ * f + (n^2 * λ^2) / 4)
    % n is on stack and represents the ring number
    dup dup mul WAVE_LENGTH dup mul mul 4 div   % (n^2*λ^2)/4
    exch WAVE_LENGTH mul FOCAL mul add          % n * λ * f + (n^2*λ^2)/4
    sqrt MAG mul                                % sqrt(n * λ * f + (n^2 * λ^2) / 4) * M
} def
%*****************************************************************

%*****************************************************************
% Calculate effective f-stop
% Usage: num_rings focal_length calc_effective_fstop → fstop
%******************************************************************
/calc_effective_fstop {
    % num_rings focal_length on stack
    % Calculate radius of innermost ring (n=1) in mm
    /fstop_fl exch def
    /fstop_r exch def

    /center_ring_area 1 calc_radius_mm MAG div dup mul pi mul def

    % Total effective area = area of center ring * number of rings
    % Calculate effective diameter from total area
    % Calculate f-stop: f/D
    /fstop_effective_area center_ring_area fstop_r mul def
    /fstop_effective_diameter fstop_effective_area 4 mul pi div sqrt def % D = 2 * sqrt(A/π) = sqrt(4A/π) def
    fstop_fl fstop_effective_diameter div 0.5 add cvi
} def
%*****************************************************************

%*****************************************************************
% Draw 8" x 10" frame around page
%*****************************************************************
/drawBorder {
    gsave   
    1 mmToPoints setlinewidth                % Set line width
    newpath
    10 mmToPoints 269 mmToPoints moveto      % Start at (10mm, 269mm)
    pagewidth 20 sub mmToPoints 0 rlineto    % Draw to the right
    0 20 pageheight sub mmToPoints rlineto   % Draw down
    20 pagewidth sub mmToPoints 0 rlineto    % Draw left
    closepath
    stroke
    grestore
} def
%*****************************************************************  

%*****************************************************************
% Draw Zone Plates in Grid Pattern
%*****************************************************************
/drawZonePlate {
    /colIndex exch def
    /rowIndex exch def

    gsave

    % Translate current position to correct grid position
    colIndex offsetx rowIndex offsety translate
    
    % Draw Punch Outline to cut zone plate from film
    0 setgray                                  
    .5 mmToPoints setlinewidth                                                  
    0 0 PUNCH_DIAMETER MAG mul 2 div mmToPoints 0 360 arc 
    stroke
    
    1 2 RINGS 2 mul {
        /n exch def
        
        /outer_radius_mm n calc_radius_mm def
        /inner_radius_mm n 1 sub calc_radius_mm def
        /annulus_width_mm outer_radius_mm inner_radius_mm sub def

        % Calculate the center of the ring (midpoint between inner and outer radii)
        /ring_center_radius_mm inner_radius_mm annulus_width_mm 2 div add def

        0 setgray
        annulus_width_mm mmToPoints setlinewidth
        0 0 ring_center_radius_mm mmToPoints 0 360 arc
        stroke
        
    } for 

    grestore
} def

/drawZoneSieve {
    /colIndex exch def
    /rowIndex exch def

    gsave

    % Translate current position to correct grid position
    colIndex offsetx rowIndex offsety translate
    
    % Draw Punch Outline to cut zone plate from film
    0 setgray                                  
    .5 mmToPoints setlinewidth                                                   
    0 0 PUNCH_DIAMETER 2 div mmToPoints 0 360 arc 
    stroke
    
    /Z RINGS 2 mul 1 sub def                                    % Z = number of zones in the sieve
    (Rings: ) print                                    
    Z ==
    (\n) print
    Z -2 2 {                                                   
        /z1 exch 1 sub def                                      % z1 = Outer most ring being calculated       
        /zw z1 1 add sqrt z1 sqrt sub center mul 2 div def      % zone width
        /zcr z1 sqrt center mul zw add def                      % zone center diameter
        /perimeter pi zcr mul def                               % perimeter of zcr
        /radius zcr 2 div def                                   % radius of zcr
        /holes zw 1.5 mul S add perimeter exch div ceiling def  % # of pinholes in ring
        /degrees 360 holes div def                              % degrees of separation between pinholes
        /starting degrees 13 sub def                            % avoids start at 0 degrees
        /pinhole zw 1.5 mul 2 div def                           % radius of pinhole in ring
        /area pinhole dup mul pi mul holes mul area add def     % keeps tracks of areas of pinholes
        DEBUG {
            (----------------- \n) print
            (Z: ) print
            Z ==
            (z1: ) print
            z1 ==
            (zw: ) print
            zw ==
            (zcr: ) print
            zcr ==
            (perimeter: ) print
            perimeter ==
            (radius: ) print
            radius ==
            (holes: ) print
            holes ==
            (degrees: ) print
            degrees ==
            (starting: ) print
            starting ==
            (pinhole: ) print
            pinhole ==
            (area: ) print
            area ==
        } if

        starting rotate                                         % set the starting angle to avoid starting at 0 degrees              
        1 1 holes {                                             % loops to print holes in a ring
            degrees rotate                                      % rotate axis by pinholes degrees of separation 
            radius 0 pinhole 0 360 arc fill                     % draw the pinhole
            /counter counter 1 add def                          % counter of # of holes printed
        } for                                               % return to next # in ring  
    } for                                                   % return to next ring 

    0 0 center 2 div 0 360 arc fill                         % print the central pinhole
    counter counter 1 add def 
    /area center 2 div dup mul pi mul area add def
    grestore
} def

/drawZonePlateDescription {
    /colIndex exch def
    /rowIndex exch def
    gsave
    
    colIndex offsetx rowIndex offsety moveto
    
    /Times-Roman findfont
    10 scalefont
    setfont
    0 setgray
    /str 150 string def
    (Focal Length: ) show
    FOCAL str cvs show
    (mm) show
    ( | Zones: ) show
    RINGS str cvs show
    ( | Center Pinhole Size: ) show
    center pointsToMicrons str cvs show
    (um) show
    ( | Zone Plate Diameter: ) show
    RINGS 2 mul 1 sub calc_radius_mm 2 mul str cvs show
    (mm) show
    ( | F/Stop: ) show
    RINGS FOCAL calc_effective_fstop str cvs show
    
    grestore
} def

/drawZoneSieveDescription {
    /colIndex exch def
    /rowIndex exch def
    
    gsave
    /Times-Roman findfont
    10 scalefont
    setfont
    0 setgray
    colIndex offsetx rowIndex offsety moveto
    /area center 2 div dup mul pi mul area add def % add the are of central pinhole 
    area sqrt MAG div pointsToMm dup mul   
    % area ==
    /fstop1 area FOCAL exch pi div 4 mul sqrt div def
    
    /zpDiameter FOCAL fstop1 div def 

    /str 150 string def
    (Focal Length: ) show
    FOCAL str cvs show
    (mm) show
    ( | Zones: ) show
    RINGS str cvs show
    ( | Center Pinhole Size: ) show
    center pointsToMicrons str cvs show
    (um) show
    ( | Zone Sieve Diameter: ) show
    zpDiameter str cvs show
    (mm) show
    ( | F/Stop: ) show
    fstop1 cvi str cvs show
    grestore
} def


% Draw border around the page
drawBorder

%Draw grid of Zone Plated
0 1 ROWS 1 sub {                                    
     /row exch def
    1 1 COLS {                                
        /col exch def
        row currentRowIndex add col drawZonePlate                 
    } for
} for
/currentRowIndex ROWS currentRowIndex add def

%Print zone plate description
currentRowIndex 1 drawZonePlateDescription
/currentRowIndex 1 currentRowIndex add def

% % Draw grid of Zone Sieves
% 0 1 ROWS 1 sub {                                    
%     /row exch def
%     1 1 COLS {                                
%         /col exch def
%         row currentRowIndex add col drawZoneSieve                 
%     } for
% } for
% /currentRowIndex ROWS currentRowIndex add def

% Print zone plate description
% currentRowIndex 1drawZoneSieveDescription
% /currentRowIndex 1 currentRowIndex add def


showpage

